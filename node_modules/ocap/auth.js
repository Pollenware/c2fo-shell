var Config  = require( 'config/auth.js' ).Config;

exports.Auth = Auth;

function Auth( net, finishHandler ) {

  var self = this;

  self.getDetails = function ( connectionId, connection, callback ) {
    var cId       = connectionId.split( '@' );
    var instance  = cId[1];
    var emulating = cId[2];
    if ( !connection || !( connection.sessionCookie ) ) {
      self.__finishHandler( connectionId );
      return;
    }
    self.net.get( 'auth/manage',
      function ( error ) {
        if ( !error )
          error = Config.networkError;
        connection.lastAction = Config.failedSignInMsg;
        console.error( Config.errorPrefix + ' ' + error );
        self.__finishHandler( connectionId, error );
      },
      function ( response ) {
        connection.lastAction = Config.userDetailsAction;
        console.log( instance + ' - ' + Config.userDetailsMsg );
        var payload           = JSON.parse( response.body ).payload;
        connection.lastActive = new Date( payload.created );
        delete payload.created;
        for (p in payload.response) {
          connection[p] = payload.response[p];
        }
        if ( connection.user_type == Config.SUPPLIER  || connection.user_type == Config.BUYER ) {
          callback( connectionId, connection );
        }
        else {
          self.__finishHandler( connectionId );
        }
      },
      instance,
      connection.sessionCookie
    );
  };

  self.isDebugging = false;

  self.net = net;

  self.signIn = function ( connectionId, password ) {
  
    var cId      = connectionId.split( '@' );
    var user     = cId[0].trim();
    var instance = cId[1].trim();
    var payload  = {
      user_name: user,
      password : password
    };

    if (cId[2]) {
      payload.euid = cId[2].trim();
    }

    console.log( Config.connectMsg );

    self.net.post( payload, 'login',
      function ( error ) {
        if ( !error )
          error = Config.networkError;
        console.error( Config.errorPrefix + ' ' + error );
        self.signInCallback( connectionId, password, user, instance, null, error );
      },
      function ( response ) {
        self.signInCallback( connectionId, password, user, instance, response );
      },
      instance
    );
  };

}
